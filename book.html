<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Booking Confirmation - Opal Stays Kilimani</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 600px; margin: 20px auto; padding: 10px; background: #f9f9f9; }
  h1, h2 { text-align: center; color: #2a9d8f; }
  label { display: block; margin-top: 15px; font-weight: bold; }
  input, select, button { width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box; font-size: 16px; }
  input[readonly] { background: #eee; }
  button { background-color: #2a9d8f; border: none; color: white; cursor: pointer; border-radius: 4px; }
  button:hover { background-color: #21867a; }
  .payment-methods { margin-top: 10px; display: flex; gap: 10px; justify-content: space-between; }
  .payment-methods button { flex: 1; }
  .summary { margin-top: 20px; font-size: 18px; font-weight: bold; color: #264653; text-align: center; }
  .modal {
    display: none;
    position: fixed; z-index: 1000; left: 0; top: 0;
    width: 100%; height: 100%;
    overflow: auto; background-color: rgba(0,0,0,0.5);
  }
  .modal-content {
    background-color: #fff; margin: 10% auto; padding: 20px;
    border-radius: 8px; max-width: 400px; position: relative;
    box-shadow: 0 2px 8px rgba(0,0,0,0.25);
  }
  .modal h3 { margin-top: 0; }
  .modal-close-btn {
    position: absolute; right: 10px; top: 10px;
    background: transparent; border: none; font-size: 20px; cursor: pointer; color: #999;
  }
  .modal-close-btn:hover { color: #333; }
  #thankYou { display: none; margin-top: 30px; background: #e0f7f5; border-radius: 6px; padding: 20px; }
</style>
</head>
<body>

<h1>Opal Stays Kilimani</h1>
<h2>Booking Confirmation</h2>

<div>
  <p><strong>Listing:</strong> <span id="listingName">Loading...</span></p>
  <p><strong>Location:</strong> <span id="listingLocation">Loading...</span></p>
  <p><strong>Price per night:</strong> $<span id="listingPrice">0.00</span></p>
</div>

<form id="bookingForm" novalidate>
  <label for="name">Your Name</label>
  <input type="text" id="name" name="name" readonly />

  <label for="email">Your Email</label>
  <input type="email" id="email" name="email" readonly />

  <label for="checkin">Check-in Date</label>
  <input type="date" id="checkin" name="checkin" required />

  <label for="checkout">Check-out Date</label>
  <input type="date" id="checkout" name="checkout" required />

  <label for="guests">Number of Guests</label>
  <input type="number" id="guests" name="guests" min="1" value="1" required />

  <div class="summary">
    Total Price: $<span id="totalPrice">0.00</span>
  </div>

  <label>Choose Payment Method</label>
  <div class="payment-methods">
    <button type="button" data-method="Stripe">Stripe</button>
    <button type="button" data-method="PayPal">PayPal</button>
    <button type="button" data-method="MPESA">MPESA</button>
    <button type="button" data-method="Airtel Money">Airtel Money</button>
  </div>

  <input type="hidden" id="selectedPaymentMethod" name="paymentMethod" required />

  <button type="submit" style="margin-top:20px;">Confirm Booking</button>
</form>

<div id="thankYou"></div>

<!-- Modals -->

<!-- Stripe Card Details Modal -->
<div id="modalStripeCard" class="modal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="stripeCardTitle">
    <button class="modal-close-btn" data-close="modalStripeCard" aria-label="Close">&times;</button>
    <h3 id="stripeCardTitle">Enter Card Details</h3>
    <form id="stripeCardForm" novalidate>
      <label for="cardNumber">Card Number</label>
      <input type="text" id="cardNumber" name="cardNumber" placeholder="1234 5678 9012 3456" required minlength="13" maxlength="19" pattern="\\d{13,19}" inputmode="numeric" />
      <label for="cardExpiry">Expiry (MM/YY)</label>
      <input type="text" id="cardExpiry" name="cardExpiry" placeholder="MM/YY" pattern="^(0[1-9]|1[0-2])\\/([0-9]{2})$" required />
      <label for="cardCVC">CVC</label>
      <input type="text" id="cardCVC" name="cardCVC" placeholder="123" pattern="\\d{3,4}" required inputmode="numeric" />
      <button type="submit" style="margin-top:15px;">Pay</button>
    </form>
  </div>
</div>

<!-- MPESA Payment Instructions Modal -->
<div id="modalMpesaInstructions" class="modal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="mpesaInstructionsTitle">
    <button class="modal-close-btn" data-close="modalMpesaInstructions" aria-label="Close">&times;</button>
    <h3 id="mpesaInstructionsTitle">MPESA Payment Instructions</h3>
    <p>Please pay <strong>$<span id="mpesaAmount"></span></strong> to <strong>MPESA Paybill: 123456</strong>, Account: <strong>OpalStays</strong>.</p>
    <button id="mpesaPaidBtn" style="margin-top:15px;">I Have Paid</button>
  </div>
</div>

<!-- MPESA Transaction ID Input Modal -->
<div id="modalMpesaTransaction" class="modal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="mpesaTransactionTitle">
    <button class="modal-close-btn" data-close="modalMpesaTransaction" aria-label="Close">&times;</button>
    <h3 id="mpesaTransactionTitle">Enter MPESA Transaction ID</h3>
    <form id="mpesaTransactionForm" novalidate>
      <input type="text" id="mpesaTransactionId" name="mpesaTransactionId" placeholder="e.g. 1234" required />
      <button type="submit" style="margin-top:15px;">Submit</button>
    </form>
  </div>
</div>

<!-- Airtel Payment Instructions Modal -->
<div id="modalAirtelInstructions" class="modal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="airtelInstructionsTitle">
    <button class="modal-close-btn" data-close="modalAirtelInstructions" aria-label="Close">&times;</button>
    <h3 id="airtelInstructionsTitle">Airtel Money Payment Instructions</h3>
    <p>Please pay <strong>$<span id="airtelAmount"></span></strong> to <strong>Airtel Money Paybill: 654321</strong>, Account: <strong>OpalStays</strong>.</p>
    <button id="airtelPaidBtn" style="margin-top:15px;">I Have Paid</button>
  </div>
</div>

<!-- Airtel Transaction ID Input Modal -->
<div id="modalAirtelTransaction" class="modal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="airtelTransactionTitle">
    <button class="modal-close-btn" data-close="modalAirtelTransaction" aria-label="Close">&times;</button>
    <h3 id="airtelTransactionTitle">Enter Airtel Money Transaction ID</h3>
    <form id="airtelTransactionForm" novalidate>
      <input type="text" id="airtelTransactionId" name="airtelTransactionId" placeholder="e.g. 1234" required />
      <button type="submit" style="margin-top:15px;">Submit</button>
    </form>
  </div>
</div>

<!-- Verification Code Modal -->
<div id="modalVerification" class="modal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="verificationTitle">
    <button class="modal-close-btn" data-close="modalVerification" aria-label="Close">&times;</button>
    <h3 id="verificationTitle">Enter Verification Code</h3>
    <form id="verificationForm" novalidate>
      <input type="text" id="verificationCode" name="verificationCode" placeholder="Enter code" required />
      <button type="submit" style="margin-top:15px;">Verify</button>
    </form>
  </div>
</div>

<!-- Error Modal -->
<div id="modalError" class="modal" aria-hidden="true">
  <div class="modal-content" role="alertdialog" aria-modal="true" aria-labelledby="errorTitle">
    <button class="modal-close-btn" data-close="modalError" aria-label="Close">&times;</button>
    <h3 id="errorTitle">Error</h3>
    <p id="errorMessage">An error occurred.</p>
  </div>
</div>

<script>
(() => {
  // Helper to get query params
  function getQueryParams() {
    const params = {};
    location.search.slice(1).split('&').forEach(pair => {
      if (!pair) return;
      const [key, val] = pair.split('=');
      params[decodeURIComponent(key)] = decodeURIComponent(val || '');
    });
    return params;
  }

  // Elements references
  const listingNameEl = document.getElementById('listingName');
  const listingLocationEl = document.getElementById('listingLocation');
  const listingPriceEl = document.getElementById('listingPrice');
  const nameInput = document.getElementById('name');
  const emailInput = document.getElementById('email');
  const checkinInput = document.getElementById('checkin');
  const checkoutInput = document.getElementById('checkout');
  const guestsInput = document.getElementById('guests');
  const totalPriceEl = document.getElementById('totalPrice');
  const paymentButtons = document.querySelectorAll('.payment-methods button');
  const selectedPaymentMethodInput = document.getElementById('selectedPaymentMethod');
  const bookingForm = document.getElementById('bookingForm');
  const thankYouDiv = document.getElementById('thankYou');

  // Modals
  const modalStripeCard = document.getElementById('modalStripeCard');
  const modalMpesaInstructions = document.getElementById('modalMpesaInstructions');
  const modalMpesaTransaction = document.getElementById('modalMpesaTransaction');
  const modalAirtelInstructions = document.getElementById('modalAirtelInstructions');
  const modalAirtelTransaction = document.getElementById('modalAirtelTransaction');
  const modalVerification = document.getElementById('modalVerification');
  const modalError = document.getElementById('modalError');
  const errorMessageEl = document.getElementById('errorMessage');

  // Forms inside modals
  const stripeCardForm = document.getElementById('stripeCardForm');
  const mpesaTransactionForm = document.getElementById('mpesaTransactionForm');
  const airtelTransactionForm = document.getElementById('airtelTransactionForm');
  const verificationForm = document.getElementById('verificationForm');

  // Payment instructions amount spans
  const mpesaAmountSpan = document.getElementById('mpesaAmount');
  const airtelAmountSpan = document.getElementById('airtelAmount');

  // Hardcoded verification code
  const VERIFICATION_CODE = '1234';

  // Variables to hold booking info
  let listingName = '';
  let listingLocation = '';
  let pricePerNight = 0;
  let totalPrice = 0;
  let selectedPaymentMethod = '';

  // --- Initialize page ---
  function init() {
    const params = getQueryParams();

    // Fetch listing info: from URL params or sessionStorage fallback
    listingName = params.listingName || sessionStorage.getItem('listingName') || 'Opal Stays Kilimani';
    listingLocation = params.location || sessionStorage.getItem('location') || 'Kilimani, Nairobi';
    pricePerNight = parseFloat(params.price) || parseFloat(sessionStorage.getItem('pricePerNight')) || 80.00;

    // Save back to sessionStorage for persistence in case user refreshes page
    sessionStorage.setItem('listingName', listingName);
    sessionStorage.setItem('location', listingLocation);
    sessionStorage.setItem('pricePerNight', pricePerNight);

    listingNameEl.textContent = listingName;
    listingLocationEl.textContent = listingLocation;
    listingPriceEl.textContent = pricePerNight.toFixed(2);

    // Fetch user name & email from URL or sessionStorage
    const userName = params.name || sessionStorage.getItem('userName') || 'Guest User';
    const userEmail = params.email || sessionStorage.getItem('userEmail') || 'guest@example.com';

    nameInput.value = userName;
    emailInput.value = userEmail;

    // Save user info too in sessionStorage
    sessionStorage.setItem('userName', userName);
    sessionStorage.setItem('userEmail', userEmail);

    // Setup event listeners
    checkinInput.addEventListener('change', updateTotalPrice);
    checkoutInput.addEventListener('change', updateTotalPrice);
    guestsInput.addEventListener('input', () => {
      if (guestsInput.value < 1) guestsInput.value = 1;
    });

    paymentButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        paymentButtons.forEach(b => b.style.backgroundColor = '#2a9d8f');
        btn.style.backgroundColor = '#1b655c';
        selectedPaymentMethod = btn.dataset.method;
        selectedPaymentMethodInput.value = selectedPaymentMethod;
      });
    });

    // Modal close buttons
    document.querySelectorAll('.modal-close-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        closeModal(btn.dataset.close);
      });
    });

    // MPESA & Airtel Paid buttons
    document.getElementById('mpesaPaidBtn').addEventListener('click', () => {
      closeModal('modalMpesaInstructions');
      openModal('modalMpesaTransaction');
    });
    document.getElementById('airtelPaidBtn').addEventListener('click', () => {
      closeModal('modalAirtelInstructions');
      openModal('modalAirtelTransaction');
    });

    // Form submissions in modals
    stripeCardForm.addEventListener('submit', handleStripePayment);
    mpesaTransactionForm.addEventListener('submit', handleMpesaTransaction);
    airtelTransactionForm.addEventListener('submit', handleAirtelTransaction);
    verificationForm.addEventListener('submit', handleVerification);

    // Booking form submit
    bookingForm.addEventListener('submit', handleBookingSubmit);

    updateTotalPrice();
  }

  function updateTotalPrice() {
    const checkin = checkinInput.value;
    const checkout = checkoutInput.value;

    if (!checkin || !checkout) {
      totalPriceEl.textContent = '0.00';
      totalPrice = 0;
      return;
    }
    const checkinDate = new Date(checkin);
    const checkoutDate = new Date(checkout);

    if (checkoutDate <= checkinDate) {
      totalPriceEl.textContent = '0.00';
      totalPrice = 0;
      return;
    }

    // Calculate nights
    const msPerDay = 1000 * 60 * 60 * 24;
    const nights = Math.round((checkoutDate - checkinDate) / msPerDay);

    totalPrice = nights * pricePerNight;
    totalPriceEl.textContent = totalPrice.toFixed(2);

    // Update payment instructions amount spans too
    mpesaAmountSpan.textContent = totalPrice.toFixed(2);
    airtelAmountSpan.textContent = totalPrice.toFixed(2);
  }

  // Open modal helper
  function openModal(id) {
    const modal = document.getElementById(id);
    if (!modal) return;
    modal.style.display = 'block';
    modal.setAttribute('aria-hidden', 'false');
    // Focus first input or button
    const focusElem = modal.querySelector('input, button');
    if (focusElem) focusElem.focus();
  }

  // Close modal helper
  function closeModal(id) {
    const modal = document.getElementById(id);
    if (!modal) return;
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden', 'true');
  }

  // Show error modal with message
  function showError(message) {
    errorMessageEl.textContent = message;
    openModal('modalError');
  }

  // Booking form submission handler
  function handleBookingSubmit(e) {
    e.preventDefault();
    if (!selectedPaymentMethod) {
      showError('Please select a payment method.');
      return;
    }
    if (!checkinInput.value || !checkoutInput.value) {
      showError('Please select valid check-in and check-out dates.');
      return;
    }
    if (totalPrice <= 0) {
      showError('Total price must be greater than zero.');
      return;
    }

    switch (selectedPaymentMethod) {
      case 'Stripe':
      case 'PayPal':
        // For demo, treat Stripe and PayPal same way: show card input modal
        openModal('modalStripeCard');
        break;
      case 'MPESA':
        openModal('modalMpesaInstructions');
        break;
      case 'Airtel Money':
        openModal('modalAirtelInstructions');
        break;
      default:
        showError('Invalid payment method selected.');
    }
  }

  // Handle Stripe card payment submission (mock)
  function handleStripePayment(e) {
    e.preventDefault();
    // Validate basic inputs (simplified)
    const cardNumber = stripeCardForm.cardNumber.value.trim();
    const cardExpiry = stripeCardForm.cardExpiry.value.trim();
    const cardCVC = stripeCardForm.cardCVC.value.trim();

    if (!/^\d{13,19}$/.test(cardNumber.replace(/\s+/g, ''))) {
      showError('Please enter a valid card number (13-19 digits).');
      return;
    }
    if (!/^(0[1-9]|1[0-2])\/\d{2}$/.test(cardExpiry)) {
      showError('Please enter a valid expiry date in MM/YY format.');
      return;
    }
    if (!/^\d{3,4}$/.test(cardCVC)) {
      showError('Please enter a valid CVC code (3 or 4 digits).');
      return;
    }

    closeModal('modalStripeCard');
    openModal('modalVerification');
  }

  // Handle MPESA transaction ID submission
  function handleMpesaTransaction(e) {
    e.preventDefault();
    const txId = mpesaTransactionForm.mpesaTransactionId.value.trim();
    if (!txId) {
      showError('Please enter the MPESA transaction ID.');
      return;
    }
    // For demo, accept any non-empty txId
    closeModal('modalMpesaTransaction');
    openModal('modalVerification');
  }

  // Handle Airtel transaction ID submission
  function handleAirtelTransaction(e) {
    e.preventDefault();
    const txId = airtelTransactionForm.airtelTransactionId.value.trim();
    if (!txId) {
      showError('Please enter the Airtel Money transaction ID.');
      return;
    }
    // For demo, accept any non-empty txId
    closeModal('modalAirtelTransaction');
    openModal('modalVerification');
  }

  // Handle verification code submission
  function handleVerification(e) {
    e.preventDefault();
    const code = verificationForm.verificationCode.value.trim();
    if (code !== VERIFICATION_CODE) {
      showError('Incorrect verification code. Please try again.');
      return;
    }
    closeModal('modalVerification');
    showThankYou();
  }

  // Show thank you message with booking details
  function showThankYou() {
    bookingForm.style.display = 'none';
    thankYouDiv.style.display = 'block';

    thankYouDiv.innerHTML = `
      <h2>Thank you for your booking, ${nameInput.value}!</h2>
      <p>Your booking details:</p>
      <ul>
        <li><strong>Listing:</strong> ${listingName}</li>
        <li><strong>Location:</strong> ${listingLocation}</li>
        <li><strong>Check-in:</strong> ${checkinInput.value}</li>
        <li><strong>Check-out:</strong> ${checkoutInput.value}</li>
        <li><strong>Guests:</strong> ${guestsInput.value}</li>
        <li><strong>Total Price:</strong> $${totalPrice.toFixed(2)}</li>
        <li><strong>Payment Method:</strong> ${selectedPaymentMethod}</li>
      </ul>
      <p>We will send you a confirmation email shortly.</p>
    `;
  }

  // Initialize on page load
  window.addEventListener('DOMContentLoaded', init);
})();
</script>

</body>
</html>
