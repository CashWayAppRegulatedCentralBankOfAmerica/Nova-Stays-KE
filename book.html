<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Book Listing - Nova Stays KE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    .readonly-input {
      background-color: #f9fafb;
      border: 1px solid #d1d5db;
      padding: 0.5rem;
      border-radius: 0.375rem;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- Header -->
  <header class="bg-white shadow p-4 mb-6">
    <h1 class="text-xl font-bold text-green-600">Nova Stays KE</h1>
  </header>

  <!-- Booking Form -->
  <div class="max-w-3xl mx-auto bg-white shadow-md rounded-lg p-6">
    <h2 class="text-lg font-semibold mb-4">Confirm Your Booking</h2>

    <div class="grid md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Guest Name</label>
        <input id="guestName" class="readonly-input w-full" type="text" readonly />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Email</label>
        <input id="guestEmail" class="readonly-input w-full" type="text" readonly />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Mobile Number</label>
        <input id="guestPhone" class="readonly-input w-full" type="text" readonly />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Listing Name</label>
        <input id="listingName" class="readonly-input w-full" type="text" readonly />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Location</label>
        <input id="listingLocation" class="readonly-input w-full" type="text" readonly />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Price Per Night (USD)</label>
        <input id="pricePerNight" class="readonly-input w-full" type="text" readonly />
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-4 mt-6">
      <div>
        <label class="block text-sm font-medium text-gray-700">Check-In Date</label>
        <input id="checkinDate" class="w-full p-2 border rounded-md" type="text" placeholder="Select check-in date" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Check-Out Date</label>
        <input id="checkoutDate" class="w-full p-2 border rounded-md" type="text" placeholder="Select check-out date" />
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-4 mt-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Guests</label>
        <select id="guestCount" class="w-full p-2 border rounded-md">
          <option value="1">1 Guest</option>
          <option value="2">2 Guests</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Total Nights</label>
        <input id="nights" class="readonly-input w-full" type="text" readonly />
      </div>
    </div>

    <div class="mt-4">
      <label class="block text-sm font-medium text-gray-700">Total Amount (USD)</label>
      <input id="totalAmount" class="readonly-input w-full" type="text" readonly />
    </div>

    <button class="mt-6 w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-md text-sm font-semibold">
      Confirm & Book Now
    </button>
  </div>

  <!-- Flatpickr & Script -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    // Fetch data from query params
    const urlParams = new URLSearchParams(window.location.search);
    const listing = urlParams.get("listing");
    const price = parseFloat(urlParams.get("price"));
    const location = urlParams.get("location");
    const user = urlParams.get("user");
    const email = urlParams.get("email");
    const phone = "0700123456"; // Example fetched number, you can dynamically inject from sign up

    document.getElementById("guestName").value = user || "Guest";
    document.getElementById("guestEmail").value = email || "guest@example.com";
    document.getElementById("guestPhone").value = phone;
    document.getElementById("listingName").value = listing;
    document.getElementById("listingLocation").value = location;
    document.getElementById("pricePerNight").value = price;

    const checkin = document.getElementById("checkinDate");
    const checkout = document.getElementById("checkoutDate");
    const nights = document.getElementById("nights");
    const total = document.getElementById("totalAmount");

    let checkinDateVal, checkoutDateVal;

    flatpickr(checkin, {
      dateFormat: "Y-m-d",
      onChange: function(selectedDates) {
        checkinDateVal = selectedDates[0];
        updateCalculation();
      }
    });

    flatpickr(checkout, {
      dateFormat: "Y-m-d",
      onChange: function(selectedDates) {
        const selected = selectedDates[0];
        if (selected) {
          const checkOutHour = selected.getHours();
          const checkOutLimit = new Date(selected);
          checkOutLimit.setHours(13); // 1300Hrs
          if (selected > checkOutLimit) {
            alert("Checkout time should not exceed 1300Hrs (1:00 PM Africa Time)");
            checkout.value = "";
          } else {
            checkoutDateVal = selected;
            updateCalculation();
          }
        }
      }
    });

    function updateCalculation() {
      if (checkinDateVal && checkoutDateVal && checkoutDateVal > checkinDateVal) {
        const diffTime = Math.abs(checkoutDateVal - checkinDateVal);
        const numNights = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        nights.value = numNights;

        const guestCount = parseInt(document.getElementById("guestCount").value);
        const totalPrice = price * numNights * (guestCount > 0 ? 1 : 1);
        total.value = totalPrice.toFixed(2);
      }
    }

    document.getElementById("guestCount").addEventListener("change", updateCalculation);
  </script>
</body>
</html>
