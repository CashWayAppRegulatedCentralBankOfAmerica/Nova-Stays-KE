<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Book Nova Stays KE</title>
  <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
  <script>
    (function() {
      emailjs.init('0ockMZ07aVnggqzsD'); // Your public key here
    })();
  </script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background: #f9fafb; font-family: Arial, sans-serif; }
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 400px;
      width: 90%;
    }
    .hidden { display: none; }
  </style>
</head>
<body class="p-4">

  <main class="container mx-auto max-w-lg bg-white p-6 rounded shadow">
    <h1 class="mb-4 text-2xl font-bold text-green-600">Book Your Stay</h1>

    <form id="bookingForm" class="mb-3">
      <div class="mb-3">
        <label for="name" class="form-label">Full Name</label>
        <input id="name" name="name" required type="text" class="form-control" />
      </div>
      <div class="mb-3">
        <label for="email" class="form-label">Email Address</label>
        <input id="email" name="email" required type="email" class="form-control" />
      </div>
      <div class="mb-3">
        <label for="checkin" class="form-label">Check-in Date</label>
        <input id="checkin" name="checkin" required type="date" class="form-control" />
      </div>
      <div class="mb-3">
        <label for="checkout" class="form-label">Check-out Date</label>
        <input id="checkout" name="checkout" required type="date" class="form-control" />
      </div>
      <button type="submit" class="btn btn-success w-100">Proceed to Payment</button>
    </form>

    <div id="confirmationMessage" class="hidden">
      <h2 class="text-green-700 mb-3">Booking Confirmed!</h2>
      <p id="finalNote"></p>
      <a href="mybooking.html" class="btn btn-primary mt-3">View My Booking</a>
    </div>
  </main>

  <!-- Payment Method Modal -->
  <div id="paymentModal" class="modal-backdrop hidden">
    <div class="modal-content">
      <h3 class="mb-3">Select Payment Method & Amount</h3>
      <form id="paymentForm">
        <div class="mb-3">
          <label for="paymentMethod" class="form-label">Payment Method</label>
          <select id="paymentMethod" required class="form-select">
            <option value="">Choose...</option>
            <option value="MPESA">MPESA</option>
            <option value="PayPal">PayPal</option>
            <option value="Credit Card">Credit Card</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="amount" class="form-label">Amount (USD)</label>
          <input id="amount" type="number" min="1" required class="form-control" />
        </div>
        <button type="submit" class="btn btn-success w-100">Pay Now</button>
        <button type="button" id="paymentCancel" class="btn btn-secondary w-100 mt-2">Cancel</button>
      </form>
    </div>
  </div>

  <!-- Confirmation Code Modal -->
  <div id="codeModal" class="modal-backdrop hidden">
    <div class="modal-content">
      <h3 class="mb-3">Enter Confirmation Code</h3>
      <input id="codeInput" type="text" placeholder="Enter code" class="form-control mb-3" />
      <button id="confirmCodeBtn" class="btn btn-success w-100">Confirm</button>
      <button id="codeCancel" class="btn btn-secondary w-100 mt-2">Cancel</button>
    </div>
  </div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  // Expecting ?listing=...&location=...
  const params = {
    listing: urlParams.get('listing') || 'N/A',
    location: urlParams.get('location') || 'N/A',
  };

  const bookingForm = document.getElementById('bookingForm');
  const paymentModal = document.getElementById('paymentModal');
  const codeModal = document.getElementById('codeModal');
  const confirmationMessage = document.getElementById('confirmationMessage');
  const finalNote = document.getElementById('finalNote');

  let paymentMethod = '';
  let amountPaid = 0;
  let bookingData = null;

  bookingForm.addEventListener('submit', e => {
    e.preventDefault();
    // Validate check-in and check-out logic
    const checkin = bookingForm.checkin.value;
    const checkout = bookingForm.checkout.value;

    if (checkout <= checkin) {
      alert('Check-out date must be after check-in date.');
      return;
    }

    // Save form data for later
    bookingData = {
      name: bookingForm.name.value.trim(),
      email: bookingForm.email.value.trim(),
      checkin,
      checkout,
    };

    // Show payment modal
    paymentModal.classList.remove('hidden');
  });

  // Payment modal events
  const paymentForm = document.getElementById('paymentForm');
  const paymentCancel = document.getElementById('paymentCancel');

  paymentCancel.addEventListener('click', () => {
    paymentModal.classList.add('hidden');
  });

  paymentForm.addEventListener('submit', e => {
    e.preventDefault();
    const method = paymentForm.paymentMethod.value;
    const amount = Number(paymentForm.amount.value);

    if (!method) {
      alert('Please select a payment method.');
      return;
    }
    if (amount <= 0) {
      alert('Please enter a valid amount.');
      return;
    }

    paymentMethod = method;
    amountPaid = amount;

    paymentModal.classList.add('hidden');
    // Show confirmation code modal
    codeModal.classList.remove('hidden');
  });

  // Code modal events
  const codeCancel = document.getElementById('codeCancel');
  const confirmCodeBtn = document.getElementById('confirmCodeBtn');
  const codeInput = document.getElementById('codeInput');

  codeCancel.addEventListener('click', () => {
    codeModal.classList.add('hidden');
  });

  confirmCodeBtn.addEventListener('click', () => {
    const code = codeInput.value.trim();
    if (code !== '1234') {
      alert('Incorrect confirmation code. Please try again.');
      return;
    }
    // Confirmation successful
    codeModal.classList.add('hidden');

    // Prepare EmailJS params
    const templateParams = {
      name: bookingData.name,
      email: bookingData.email,
      listing: params.listing,
      location: params.location,
      checkin: bookingData.checkin,
      checkout: bookingData.checkout,
      amount: amountPaid,
      method: paymentMethod,
      date: new Date().toLocaleString()
    };

    emailjs.send('service_g5v9kbm', 'template_eelornk', templateParams)
      .then(() => {
        // Save booking info with confirmation status and date/time
        const savedBooking = {
          listing: params.listing,
          location: params.location,
          user: bookingData.name,
          email: bookingData.email,
          amountPaid: amountPaid,
          paymentMethod: paymentMethod,
          checkinDate: bookingData.checkin,
          checkoutDate: bookingData.checkout,
          bookingDateTime: templateParams.date,
          status: 'Confirmed'
        };
        localStorage.setItem('latestBooking', JSON.stringify(savedBooking));

        bookingForm.classList.add('hidden');
        confirmationMessage.classList.remove('hidden');
        finalNote.textContent = `You have successfully booked ${params.listing} in ${params.location} for ${bookingData.name}. Payment of $${amountPaid} via ${paymentMethod} received.`;
      })
      .catch((error) => {
        alert('Failed to send booking email. Please try again.');
        console.error('EmailJS error:', error);
      });
  });
</script>

</body>
</html>
